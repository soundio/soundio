
<script type="module">
    import Soundstage, { register } from './module.js';
    import Instrument from './nodes/instrument.js';

    register('bonk', function(context) {
        return new Instrument(context, {
            voice: {
                nodes: [
                    { id: 'harmonic-1',  type: 'tone', data: { type: 'sine', detune: 0 }},
                    { id: 'gain-1', type: 'gain', data: { gain: 1 }},
                    { id: 'harmonic-2',  type: 'tone', data: { type: 'sine', detune: 1200 }},
                    { id: 'gain-2', type: 'gain', data: { gain: 0.5 }},
                    { id: 'harmonic-3',  type: 'tone', data: { type: 'sine', detune: 1800 }},
                    { id: 'gain-3', type: 'gain', data: { gain: 0.25 }},
                    { id: 'harmonic-4',  type: 'tone', data: { type: 'sine', detune: 2400 }},
                    { id: 'gain-4', type: 'gain', data: { gain: 0.125 }},
                    { id: 'harmonic-5',  type: 'tone', data: { type: 'sine', detune: 2700 }},
                    { id: 'gain-5', type: 'gain', data: { gain: 0.0625 }},
                    { id: 'harmonic-6',  type: 'tone', data: { type: 'sine', detune: 3000 }},
                    { id: 'gain-6', type: 'gain', data: { gain: 0.03125 }},
                    { id: 'envelope', type: 'envelope', data: {
                        attack: [
                            [0,     "step",   0],
                            [0.003, "linear", 1],
                            [0.003, "target", 0, 0.06]
                        ]
                    }},
                    { id: 'gain', type: 'gain', data: { gain: 0 }}
                ],

                connections: [
                    { source: 'harmonic-1', target: 'gain-1' },
                    { source: 'harmonic-2', target: 'gain-2' },
                    { source: 'harmonic-3', target: 'gain-3' },
                    { source: 'harmonic-4', target: 'gain-4' },
                    { source: 'harmonic-5', target: 'gain-5' },
                    { source: 'harmonic-6', target: 'gain-6' },
                    { source: 'gain-1',     target: 'gain' },
                    { source: 'gain-2',     target: 'gain' },
                    { source: 'gain-3',     target: 'gain' },
                    { source: 'gain-4',     target: 'gain' },
                    { source: 'gain-5',     target: 'gain' },
                    { source: 'gain-6',     target: 'gain' },
                    { source: 'envelope',   target: 'gain.gain' }
                ],

                __start: {
                    'harmonic-1': { frequency: { 1: { type: 'none' }}},
                    'harmonic-2': { frequency: { 1: { type: 'none' }}},
                    'harmonic-3': { frequency: { 1: { type: 'none' }}},
                    'harmonic-4': { frequency: { 1: { type: 'none' }}},
                    'harmonic-5': { frequency: { 1: { type: 'none' }}},
                    'harmonic-6': { frequency: { 1: { type: 'none' }}},
                    'envelope': { gain: { 2: { type: 'logarithmic', min: 0.00390625, max: 1 }}}
                },

                output: 'gain'
            }
        }); 
    });

    const stage  = new Soundstage();
    const output = stage.createNode('output');
    const source = stage.createNode('bonk', {
            voice: {
                nodes: [
                    { id: 'harmonic-1',  type: 'tone', data: { type: 'sine', detune: 0 }},
                    { id: 'gain-1', type: 'gain', data: { gain: 1 }},
                    { id: 'harmonic-2',  type: 'tone', data: { type: 'sine', detune: 1200 }},
                    { id: 'gain-2', type: 'gain', data: { gain: 0.5 }},
                    { id: 'harmonic-3',  type: 'tone', data: { type: 'sine', detune: 1800 }},
                    { id: 'gain-3', type: 'gain', data: { gain: 0.25 }},
                    { id: 'harmonic-4',  type: 'tone', data: { type: 'sine', detune: 2400 }},
                    { id: 'gain-4', type: 'gain', data: { gain: 0.125 }},
                    { id: 'harmonic-5',  type: 'tone', data: { type: 'sine', detune: 2700 }},
                    { id: 'gain-5', type: 'gain', data: { gain: 0.0625 }},
                    { id: 'harmonic-6',  type: 'tone', data: { type: 'sine', detune: 3000 }},
                    { id: 'gain-6', type: 'gain', data: { gain: 0.03125 }},
                    { id: 'envelope', type: 'envelope', data: {
                        attack: [
                            [0,     "step",   0],
                            [0.003, "linear", 1],
                            [0.003, "target", 0, 0.06]
                        ]
                    }},
                    { id: 'gain', type: 'gain', data: { gain: 0 }}
                ],

                connections: [
                    { source: 'harmonic-1', target: 'gain-1' },
                    { source: 'harmonic-2', target: 'gain-2' },
                    { source: 'harmonic-3', target: 'gain-3' },
                    { source: 'harmonic-4', target: 'gain-4' },
                    { source: 'harmonic-5', target: 'gain-5' },
                    { source: 'harmonic-6', target: 'gain-6' },
                    { source: 'gain-1',     target: 'gain' },
                    { source: 'gain-2',     target: 'gain' },
                    { source: 'gain-3',     target: 'gain' },
                    { source: 'gain-4',     target: 'gain' },
                    { source: 'gain-5',     target: 'gain' },
                    { source: 'gain-6',     target: 'gain' },
                    { source: 'envelope',   target: 'gain.gain' }
                ],

                __start: {
                    'harmonic-1': { frequency: { 1: { type: 'none' }}},
                    'harmonic-2': { frequency: { 1: { type: 'none' }}},
                    'harmonic-3': { frequency: { 1: { type: 'none' }}},
                    'harmonic-4': { frequency: { 1: { type: 'none' }}},
                    'harmonic-5': { frequency: { 1: { type: 'none' }}},
                    'harmonic-6': { frequency: { 1: { type: 'none' }}},
                    'envelope': { gain: { 2: { type: 'logarithmic', min: 0.00390625, max: 1 }}}
                },

                output: 'gain'
            }
        });

    window.stage = stage;

    //console.log(stage.time, source);
    stage.createConnector(source, output);

    // Clickety click
    document.addEventListener('click', function(e) {
        const now = window.performance.now();
        source.cue(stage.time + stage.outputLatency, 'note', Math.random() * 20 + 40, 1, 0.9);
        //source.cue(stage.time + stage.outputLatency, 'note', 59, 1, 0.8);
    });
</script>
