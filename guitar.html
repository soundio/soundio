<!DOCTYPE html>
<html lang="en">
<head template-fn="import:package.json">
    <meta charset="utf-8" />
    <meta name="author" content="@{[author.twitter]}" />
    <meta name="description" content="Documentation for {[title]}. {[description]}" />
    <meta name="viewport" content="width=device-width" />

    <title>{[title]}</title>

    <script>
    document.documentElement.className = 'js';
    window.DEBUG = false;
    </script>

    <link rel="stylesheet" href="../bolt/css/html.css" />
	<link rel="stylesheet" href="../bolt/css/svg.css" />
	<link rel="stylesheet" href="../bolt/css/body.css" />
	<link rel="stylesheet" href="../bolt/css/input.css" />
	<link rel="stylesheet" href="../bolt/css/label.css" />
	<link rel="stylesheet" href="../bolt/css/block.css" />
	<link rel="stylesheet" href="../bolt/css/index.css" />
	<link rel="stylesheet" href="../bolt/css/layer.css" />
	<link rel="stylesheet" href="../bolt/css/button.css" />
	<link rel="stylesheet" href="../bolt/css/thumb.css" />
    <link rel="stylesheet" href="../bolt/css/bubble.css" />
	<link rel="stylesheet" href="../bolt/css/type.css" />
	<link rel="stylesheet" href="../bolt/css/text.css" />
	<link rel="stylesheet" href="../bolt/css/color.css" />
	<link rel="stylesheet" href="../bolt/css/modifiers.css" />
    <link rel="stylesheet" href="../bolt/components/grid/grid.css" />
	<link rel="stylesheet" href="../bolt/components/dialog/dialog.css" />

    <link rel="stylesheet" href="css/thumb.css" />
    <link rel="stylesheet" href="css/node-block.css" />
    <link rel="stylesheet" href="css/guitar.css" />
    <link rel="stylesheet" href="components/sparky/midi/style.css" />

    <!-- Preload to prevent empty cache on first render. Doesnt work, but it's
         a nice idea anyway. -->
    <link rel="stylesheet" href="../dom/components/control/range-control.css" />

    <template id="range-control-template">
        <link rel="stylesheet" href="../dom/components/control/range-control.css" />
        <input class="control-input" type="range" id="input" value="{[inputValue]}" min="0" max="1" step="any" />
        <label class="control-label" for="input"><slot></slot></label>
        <output class="control-output">{[prefix]}{[displayValue]}<abbr>{[displayUnit]}</abbr></output>
        <template fn="get:ticks each">
            <input class="tick-input" type="radio" name="tick" id="tick-{[value]}" value="{[tickValue|float-string]}" :value="{[root.inputValue|float-string]}" />
            <label class="tick-label" :style="left: calc(0.5rem + (100% - 1rem) * {[tickValue]});" :for="tick-{[value]}">{[displayValue]}</label>
        </template>
        <slot name="plugs"></slot>
    </template>

    <template id="node-input">
        {[data.name]} {[data]}
        <select value="{[data.channels|numbers-string:',']}">
            <option value="0,1" selected>1-2</option>
            <option value="0">1</option>
            <option value="1">2</option>
        </select>
    </template>

    <template id="node-mix">
        <range-control fn="param:pan" unit="pan" min="-1" max="1" transform="linear" ticks="-1 0 1">
            <span class="text-10">Pan</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-pan-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:pan" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-pan-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:gain" unit="dB" min="-60dB" max="1" transform="linear-logarithmic" ticks="0 0.0009765625 0.001953125 0.00390625 0.0078125 0.015625 0.03125 0.0625 0.125 0.25 0.5 1">
            <span class="text-10">Gain</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-gain-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:gain" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-gain-toggle">
            <template include="#param-controls-toggle"></template>
        </form>
    </template>

    <template id="source-select-button">
        <label class="source-select-button select-button button">
            <select id="source-select" :value="{[type]}">
                <option selected value="tone">Tone</option>
                <option value="noise">Noise</option>
            </select>
        </label>
    </template>

    <template id="tone-source">
        <div class="radios-block block">
            <input class="masked" type="radio" name="tone-synth-source-{[0]}-type" :value="{[1.data.type]}" value="square" id="tone-synth-source-{[0]}-type-square">
            <label title="Square" class="square-radio-button radio-button button" for="tone-synth-source-{[0]}-type-square"></label>
            <input class="masked" type="radio" name="tone-synth-source-{[0]}-type" :value="{[1.data.type]}" value="sine" id="tone-synth-source-{[0]}-type-sine">
            <label title="Sine" class="sine-radio-button radio-button button" for="tone-synth-source-{[0]}-type-sine"></label>
            <input class="masked" type="radio" name="tone-synth-source-{[0]}-type" :value="{[1.data.type]}" value="triangle" id="tone-synth-source-{[0]}-type-triangle">
            <label title="Triangle" class="triangle-radio-button radio-button button" for="tone-synth-source-{[0]}-type-triangle"></label>
            <input class="masked" type="radio" name="tone-synth-source-{[0]}-type" :value="{[1.data.type]}" value="sawtooth" id="tone-synth-source-{[0]}-type-sawtooth">
            <label title="Sawtooth" class="sawtooth-radio-button radio-button button" for="tone-synth-source-{[0]}-type-sawtooth"></label>
        </div>
        <range-control :value="{[1.data.detune]}" unit="semitone" min="-1200" max="2400" transform="linear" ticks="-1200 -700 0 700 1200 1600 1900 2200 2400"><span class="text-10">Tune</span></range-control>
        <range-control :value="{[1.data.pan]}" unit="pan" min="-1" max="1" transform="linear" ticks="-1 0 1"><span class="text-10">Pan</span></range-control>
        <range-control :value="{[1.data.mix]}" unit="dB" min="-36dB" max="0dB" transform="linear-logarithmic" ticks="0 0.015625 0.03125 0.0625 0.125 0.25 0.5 1"><span class="text-10">Mix</span></range-control>
    </template>

    <template id="noise-source">
        <div class="radios-block block">
            <input class="masked" type="radio" name="noise-source-{[0]}-type" :value="{[1.data.type]}" value="white" id="noise-source-{[0]}-type-white">
            <label title="White" class="white-radio-button radio-button button" for="noise-source-{[0]}-type-white"></label>
            <input class="masked" type="radio" name="noise-source-{[0]}-type" :value="{[1.data.type]}" value="pink" id="noise-source-{[0]}-type-pink">
            <label title="Pink" class="white-radio-button radio-button button" for="noise-source-{[0]}-type-pink"></label>
            <input class="masked" type="radio" name="noise-source-{[0]}-type" :value="{[1.data.type]}" value="brown" id="noise-source-{[0]}-type-brown">
            <label title="Brown" class="brown-radio-button radio-button button" for="noise-source-{[0]}-type-brown"></label>
        </div>
        <range-control :value="{[1.data.pan]}" unit="pan" min="-1" max="1" transform="linear" ticks="-1 0 1"><span class="text-10">Pan</span></range-control>
        <range-control :value="{[1.data.mix]}" unit="dB" min="-36dB" max="0dB" transform="linear-logarithmic" ticks="0 0.015625 0.03125 0.0625 0.125 0.25 0.5 1"><span class="text-10">Mix</span></range-control>
    </template>

    <template id="tone-synth-gain-block">
        <div class="scales-block block">
            <label class="text-10 row-1 span-2 no-wrap">Gain via note</label>

            <range-control class="row-2" :value="{[gain.min]}" unit="dB" min="-48dB" max="0dB" transform="logarithmic" ticks="-48dB -36dB -24dB -12dB 0dB">
                <span class="text-10">Min</span>
            </range-control>

            <range-control class="row-2" :value="{[gain.max]}" unit="dB" min="-48dB" max="0dB" transform="logarithmic" ticks="-48dB -36dB -24dB -12dB 0dB">
                <span class="text-10">Max</span>
            </range-control>

            <label class="text-10 row-1 span-2 no-wrap">Rate via note</label>

            <range-control class="row-2" :value="{[rate.min]}" min="0.25" max="4" transform="logarithmic" ticks="0.25 1 4">
                <span class="text-10">Min</span>
            </range-control>

            <range-control class="row-2" :value="{[rate.max]}" min="0.25" max="4" transform="logarithmic" ticks="0.25 1 4">
                <span class="text-10">Max</span>
            </range-control>
        </div>
    </template>

    <template id="tone-synth-octave-block">
        <div class="scales-block block">
            <range-control class="row-1 span-2" :value="{[gain.scale]}" min="-2" max="2" transform="linear" ticks="-2 -1 0 1 2">
                <span class="text-10 no-wrap">Per octave</span>
            </range-control>

            <range-control class="row-1 span-2" :value="{[rate.scale]}" min="-2" max="2" transform="linear" ticks="-2 -1 0 1 2">
                <span class="text-10 no-wrap">Per octave</span>
            </range-control>
        </div>
    </template>

    <template id="node-nodes/tone-synth.js">
        <a class="midi-thumb thumb" href="#node-{[id]}-toggle"></a>

        <form fn="controls" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-toggle">
            <template include="#node-controls-toggle"></template>
        </form>

        <section class="sources-block block">
            <article fn="get:data.sources entries each">
                <template fn="get:1" include="#source-select-button"></template>
                <template include="#{[1.type]}-source"></template>
            </article>
        </section>

        <div class="envelopes-block block">
            <div fn="get:data.gainEnvelope entries each">
                <h3 class="text-10">{[0]}</h3>
                <div fn="get:1">
                    <svg fn="envelope-control" class="envelope-svg" viewBox="0 -1.125 2 1.125" y-transform="linear-logarithmic" y-min="-36dB" y-max="1.125" y-ticks="0dB -6dB -12dB -18dB -24dB -30dB -36dB -42dB -48dB" preserveAspectRatio="xMinYMid slice">
                        <text text-anchor="end" x="-0.05" y="-0.965" style="font-size: 0.07; fill: #01181e;">0</text>
                        <text text-anchor="end" x="-0.05" y="0.035" style="font-size: 0.07; fill: #01181e;">-∞</text>
                        <use fn="each" include="#{[1]}-db-control"></use>
                    </svg>
                </div>
            </div>
        </div>

        <template fn="get:data.data.velocity.gain" include="#tone-synth-gain-block"></template>
        <template fn="get:data.data.frequency.gain" include="#tone-synth-octave-block"></template>

        <div class="envelopes-block block">
            <div fn="get:data.frequencyEnvelope entries each">
                <h3 class="text-10">{[0]}</h3>
                <div fn="get:1">
                    <svg fn="envelope-control" class="envelope-svg" viewBox="0 -1 2 1" y-transform="logarithmic" y-min="16" y-max="16384" y-ticks="22.5 55 110 220 440 880 1760 3520 7040 14080" preserveAspectRatio="xMinYMax slice">
                        <text text-anchor="end" x="-0.05" y="-0.965" style="font-size: 0.07; fill: #01181e;">16k</text>
                        <text text-anchor="end" x="-0.05" y="0.035" style="font-size: 0.07; fill: #01181e;">16</text>
                        <use fn="each" include="#{[1]}-hz-control"></use>
                    </svg>
                </div>
            </div>
        </div>

        <template fn="get:data.data.velocity.frequency" include="#tone-synth-gain-block"></template>
        <template fn="get:data.data.frequency.frequency" include="#tone-synth-octave-block"></template>

        <range-control fn="param:pitch" unit="" min="-2" max="2" ticks="-2 -1 0 1 2">
            <span class="text-10">Pitch</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-pitch-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:pitch" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-pitch-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:frequency" unit="" min="0.125" max="2" transform="logarithmic" ticks="0.125 0.25 0.5 1 2">
            <span class="text-10">Frequency</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-frequency-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:frequency" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-frequency-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:Q" unit="Q" min="0.16" max="20" transform="logarithmic" ticks="0.16 0.32 0.64 1.25 2.5 5 10 20">
            <span class="text-10">Q</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-Q-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:Q" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-Q-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:volume" unit="dB" min="-48dB" max="1" transform="linear-logarithmic" ticks="0 0.00390625 0.0078125 0.015625 0.03125 0.0625 0.125 0.25 0.5 1">
            <span class="text-10">Output</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-output-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:volume" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-output-toggle">
            <template include="#param-controls-toggle"></template>
        </form>
    </template>

    <template id="node-nodes/flanger.js">
        <range-control fn="param:gain" unit="dB" min="-48dB" max="1" transform="linear-logarithmic" ticks="0 0.00390625 0.0078125 0.015625 0.03125 0.0625 0.125 0.25 0.5 1">
            <span class="text-10">Gain</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-gain-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:gain" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-gain-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:delay" unit="s" min="0.0125" max="2" transform="linear-logarithmic" ticks="0 0.02 0.04 0.06 0.08 0.1 0.2 0.4 0.6 0.8 1 2">
            <span class="text-10">Delay</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-delay-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:delay" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-delay-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:frequency" unit="Hz" min="0.083333333" max="96" transform="linear-logarithmic" ticks="0 0.1 0.2 0.4 0.6 0.8 1 2 4 6 8 10 20 40 60 80">
            <span class="text-10">LFO Frequency</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-frequency-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:frequency" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-frequency-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:depth" unit="s" min="0.012" max="0.18" transform="linear-logarithmic" prefix="±" ticks="0 0.02 0.04 0.06 0.08 0.1 0.12 0.14 0.16 0.18">
            <span class="text-10">LFO Depth</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-depth-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:depth" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-depth-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:feedback" unit="dB" min="-37.3dB" max="1" transform="linear-logarithmic" ticks="0 -36dB -30dB -24dB -18dB -12dB -6dB 0dB">
            <span class="text-10">Feedback</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-feedback-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:feedback" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-feedback-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:wet" unit="dB" min="-48dB" max="1" transform="linear-logarithmic" ticks="0 0.00390625 0.0078125 0.015625 0.03125 0.0625 0.125 0.25 0.5 1">
            <span class="text-10">Wet</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-wet-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:wet" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-wet-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:dry" unit="dB" min="-48dB" max="1" transform="linear-logarithmic" ticks="0 0.00390625 0.0078125 0.015625 0.03125 0.0625 0.125 0.25 0.5 1">
            <span class="text-10">Dry</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-dry-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:dry" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-dry-toggle">
            <template include="#param-controls-toggle"></template>
        </form>
    </template>

    <template id="node-compressor">
        <range-control fn="param:threshold" min="-60" max="0" transform="linear" ticks="-60 -54 -48 -42 -36 -30 -24 -18 -12 -6 0">
            <span class="text-10">Threshold</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-threshold-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:threshold" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-threshold-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:ratio" min="1" max="20" transform="cubic">
            <span class="text-10">Ratio</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-ratio-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:ratio" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-ratio-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:knee" min="0" max="40" transform="cubic">
            <span class="text-10">Knee</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-knee-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:knee" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-knee-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:attack" unit="s" min="0.012" max="0.8" transform="linear-logarithmic" ticks="0 0.02 0.04 0.06 0.08 0.1 0.2 0.4 0.6 0.8">
            <span class="text-10">Attack</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-attack-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:attack" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-attack-toggle">
            <template include="#param-controls-toggle"></template>
        </form>

        <range-control fn="param:release" unit="s" min="0.012" max="0.8" transform="linear-logarithmic" ticks="0 0.02 0.04 0.06 0.08 0.1 0.2 0.4 0.6 0.8">
            <span class="text-10">Release</span>
            <a class="midi-thumb thumb" href="#node-{[id]}-release-toggle" slot="plugs"></a>
        </range-control>

        <form fn="controls:release" class="controls-toggle-block toggle-block block {[action]}" toggleable id="node-{[target.id]}-release-toggle">
            <template include="#param-controls-toggle"></template>
        </form>
    </template>

    <template id="node-output" fn="get:data">
        {[id]} {[data.name]} {[data.channels]}
        <!--select value="{[channels|numbers-string:',']}">
            <option value="0,1" selected>1-2</option>
            <option value="0">1</option>
            <option value="1">2</option>
        </select-->
    </template>

    <template id="control-source-keyboard">
        <div class="key-source-grid source-grid">
            <input class="key-code-input code-input" type="text" maxlength="1" :value="{[key]}" />
        </div>
    </template>

    <template id="control-source-note-input">
        <label class="name-code-select-button code-select-button select-button button">
            <select :value="{[name|to-note-number|int-string]}">
                <option fn="midi-note-names each" value="{[number]}">{[name]}</option>
            </select>
        </label>
    </template>

    <template id="control-source-control-input">
        <label class="name-code-select-button code-select-button select-button button">
            <select :value="{[name|to-control-number|int-string]}">
                <option fn="midi-control-names each" value="{[number]}">{[name]}</option>
            </select>
        </label>
    </template>

    <template id="control-source-number-input">
        <input class="number-code-input code-input" type="number" min="0" max="127" :value="{[name]}" />
    </template>

    <template id="control-source-midi">
        <div class="midi-source-grid source-grid">
            <input class="channel-code-input code-input" type="number" min="1" max="16" :value="{[channel]}" />
            <label class="type-code-select-button code-select-button select-button button {[type|is:'all'|yesno:'last','']}">
                <select id="" :value="{[type]}">
                    <option value="all">all</option>
                    <option fn="midi-types each" value="{[.]}">{[.]}</option>
                </select>
            </label>
            <template include="{[type|to-control-source-name-template-id]}"></template>
        </div>
    </template>

    <template id="node-control-source-keyboard">
        <div class="key-source-grid source-grid">
            <input class="key-code-input code-input" type="text" maxlength="1" :value="{[key]}" />
        </div>
    </template>

    <template id="node-control-source-midi">
        <div class="midi-source-grid source-grid">
            <input class="channel-code-input code-input" type="number" min="1" max="16" :value="{[channel]}" />
            <output class="code-output">{[type]}</output>
        </div>
    </template>

    <template id="control-table">
        <table class="control-table">
            <thead>
                <tr>
                    <th class="text-10">Source</th>
                    <!--th class="text-10">Type</th>
                    <th class="text-10">Name</th-->
                    <th class="text-10">Value transform</th>
                </tr>
            </thead>
            <tbody>
                <tr fn="each">
                    <td fn="get:source">
                        <template include="#control-source-{[device]}"></template>
                    </td>
                    <!--td><input class="type-code-input code-input" type="text" :value="{[data.type]}" /></td>
                    <td><input class="name-code-input code-input" type="text" :value="{[data.name]}" /></td-->
                    <td>
                        <div class="transform-grid">
                            <label class="transform-code-select-button code-select-button select-button button {[data.transform|is:'pass'|yesno:'none-value','']}">
                                <select id="" :value="{[data.transform]}">
                                    <option fn="transforms entries each" value="{[0]}">{[0]}</option>
                                </select>
                            </label>
                            <input class="min-code-input code-input" type="text" :value="{[data.min]}" hidden="{[data.transform|is:'pass']}" />
                            <input class="max-code-input code-input" type="text" :value="{[data.max]}" hidden="{[data.transform|is:'pass']}" />
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </template>

    <template id="controls-keyboard-index">
        <h3 class="text-10">Keyboard</h3>
        <ul class="control-index index">
            <li fn="each">
                <template fn="get:source" include="#control-source-{[device]}"></template>
                <div fn="get:data" class="transform-grid">
                    <label class="transform-code-select-button code-select-button select-button button {[transform|is:'pass'|yesno:'none-value','']}">
                        <select id="" :value="{[transform]}">
                            <option value="switch">switch</option>
                            <option value="toggle">toggle</option>
                        </select>
                    </label>
                    <input class="min-code-input code-input" type="number" :value="{[min]}" hidden="{[transform|is:'pass']}" />
                    <input class="max-code-input code-input" type="number" :value="{[max]}" hidden="{[transform|is:'pass']}" />
                </div>
                <button type="button" class="small-remove-thumb remove-thumb thumb" fn="on:click,remove">Remove</button>
            </li>
        </ul>
    </template>

    <template id="controls-midi-index">
        <h3 class="text-10">MIDI</h3>
        <ul class="control-index index">
            <li fn="each">
                <template fn="get:source" include="#control-source-{[device]}"></template>
                <div class="transform-grid">
                    <label class="transform-code-select-button code-select-button select-button button {[transform|is:'pass'|yesno:'none-value','']}">
                        <select :value="{[transform]}">
                            <option fn="transforms each" :value="{[0]}">{[0]}</option>
                        </select>
                    </label>
                    <input class="min-code-input code-input" type="number" :value="{[min]}" hidden="{[transform|is:'pass']}" />
                    <input class="max-code-input code-input" type="number" :value="{[max]}" hidden="{[transform|is:'pass']}" />
                </div>
                <button type="button" class="small-remove-thumb remove-thumb thumb" fn="on:click,remove">Remove</button>
            </li>
        </ul>
    </template>

    <template id="node-controls-keyboard-index">
        <h3 class="text-10">Keyboard map</h3>
        <ul class="control-index index">
            <li fn="each">
                <div class="source-grid">
                    <output class="code-output">piano</output>
                </div>
                <div fn="get:data" class="transform-grid">
                    <input class="number-code-input code-input" type="number" :value="{[max]}" />
                </div>
                <button type="button" class="small-remove-thumb remove-thumb thumb" fn="on:click,remove">Remove</button>
            </li>
        </ul>
    </template>

    <template id="node-controls-midi-index">
        <h3 class="text-10">MIDI</h3>
        <ul class="control-index index">
            <li fn="each">
                <template fn="get:source" include="#node-control-source-{[device]}"></template>
                <button type="button" class="small-remove-thumb remove-thumb thumb" fn="on:click,remove">Remove</button>
            </li>
        </ul>
    </template>

    <template id="node-controls-toggle">
        <template fn="get:controls filter-controls-keyboard" include="{[length|yesno:'#node-controls-keyboard-index','']}"></template>
        <template fn="get:controls filter-controls-midi" include="{[length|yesno:'#node-controls-midi-index','']}"></template>
        <div class="buttons-block block">
            <button type="button" class="bottom-button button" fn="scope" action="piano-keyboard">Keyboard as Piano</button>
            <button type="button" class="bottom-button button" fn="scope" action="learn-midi-defaults">Learn MIDI channel</button>
        </div>
    </template>

    <template id="param-controls-toggle">
        <template fn="get:controls filter-controls-keyboard" include="{[length|yesno:'#controls-keyboard-index','']}"></template>
        <template fn="get:controls filter-controls-midi" include="{[length|yesno:'#controls-midi-index','']}"></template>
        <div class="buttons-block block">
            <button type="button" class="bottom-button button" fn="scope" action="learn-midi">Learn MIDI</button>
            <button type="button" class="bottom-button button" fn="scope" action="learn-keyboard">Learn Key</button>
        </div>
    </template>

    <template id="node-nodes/metronome.js">
        <p>Tick {[data.tick]}</p>
        <p>Tick {[data.tock]}</p>
        <ul>
            <li fn="get:data.events each">{[.]}</li>
        </ul>
        <range-control fn="param:gain" unit="dB" min="-48dB" max="1" transform="linear-logarithmic" ticks="0 0.00390625 0.0078125 0.015625 0.03125 0.0625 0.125 0.25 0.5 1"><span class="text-10">Output</span></range-control>
    </template>
</head>

<body>
    <svg class="defs-svg">
        <defs>
            <linearGradient id="handle-gradient" x1="0" x2="0" y1="0" y2="1">
                <stop class="stop-1" offset="0%"/>
                <stop class="stop-2" offset="100%"/>
            </linearGradient>

            <style>
                .stop-1 {
                    stop-color: hsl(192,0%,96.8%);
                }

                .stop-2 {
                    stop-color: hsl(192,0%,55%);
                }

                /*
                [type="range"]::-webkit-slider-thumb {
                	background-image: linear-gradient(hsl(192,0%,96.8%), hsl(192,0%,55%));
                	box-shadow: inset 0 0 5px 1px hsla(198,30%,20%,0.6);
                }

                [type="range"]:focus::-webkit-slider-thumb {
                	box-shadow: inset 0 0 5px 2px hsla(192,50%,40%,0.4);
                	box-shadow: inset 0 0 3px 1px hsla(192,77%,12%,0.63);
                	background-image: linear-gradient(hsl(192,40%,96.8%), hsl(165,24%,55%));
                }
                */
            </style>

            <circle id="control-handle" class="control-point" cx="0" cy="0" r="0.0375"></circle>

            <circle id="step-db-control" fn="scope" class="control control-handle control-point" tabindex="0" :cx="{[0]}" :cy="{[2|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}" r="0.0375"></circle>
            <circle id="linear-db-control" fn="scope" class="control control-handle control-point" tabindex="0" :cx="{[0]}" :cy="{[2|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}" r="0.0375"></circle>
            <circle id="exponential-db-control" fn="scope" class="control control-handle control-point" tabindex="0" :cx="{[0]}" :cy="{[2|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}" r="0.0375"></circle>
            <g id="target-db-control" class="control" tabindex="0">
                <line class="control-line" :x1="{[0]}" :x2="{[.|sum03]}" :y1="{[valueAtBeat|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}" :y2="{[2|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}"></line>
                <line class="thin-control-line control-line" :x1="{[0]}" :x2="{[.|sum033333]}" :y1="{[2|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}" :y2="{[2|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}"></line>
                <use fn="scope" class="control-handle" href="#control-handle" :x="{[0]}" :y="{[valueAtBeat|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}" width="0.075" height="0.075"></use>
                <use fn="scope" class="duration-handle" href="#control-handle" :x="{[.|sum03]}" :y="{[2|normalise:linear-logarithmic,0.00390625,1|multiply:-1]}" width="0.075" height="0.075"></use>
            </g>

            <circle id="step-hz-control" fn="scope" class="control control-handle control-point" tabindex="0" :cx="{[0]}" :cy="{[2|normalise:logarithmic,16,16384|multiply:-1]}" r="0.0375"></circle>
            <circle id="linear-hz-control" fn="scope" class="control control-handle control-point" tabindex="0" :cx="{[0]}" :cy="{[2|normalise:logarithmic,16,16384|multiply:-1]}" r="0.0375"></circle>
            <circle id="exponential-hz-control" fn="scope" class="control control-handle control-point" tabindex="0" :cx="{[0]}" :cy="{[2|normalise:logarithmic,16,16384|multiply:-1]}" r="0.0375"></circle>
            <g id="target-hz-control" class="control" tabindex="0">
                <line class="control-line" :x1="{[0]}" :x2="{[.|sum03]}" :y1="{[valueAtBeat|normalise:logarithmic,16,16384|multiply:-1]}" :y2="{[2|normalise:logarithmic,16,16384|multiply:-1]}"></line>
                <line class="thin-control-line control-line" :x1="{[0]}" :x2="{[.|sum033333]}" :y1="{[2|normalise:logarithmic,16,16384|multiply:-1]}" :y2="{[2|normalise:logarithmic,16,16384|multiply:-1]}"></line>
                <use fn="scope" class="control-handle" href="#control-handle" :x="{[0]}" :y="{[valueAtBeat|normalise:logarithmic,16,16384|multiply:-1]}" width="0.075" height="0.075"></use>
                <use fn="scope" class="duration-handle" href="#control-handle" :x="{[.|sum03]}" :y="{[2|normalise:logarithmic,16,16384|multiply:-1]}" width="0.075" height="0.075"></use>
            </g>



            <style>
                .icon-stroke {
                    fill: none;
                    /* A chrome bug is preventing us using currentcolor */
                    stroke: #00181f;
                	stroke-width: 1.5;
                	stroke-linecap: round;
                	stroke-linejoin: round;
                }

                .icon-fill {
                    /* A chrome bug is preventing us using currentcolor */
                    fill: #00181f;
                    stroke: none;
                }

                svg {
                    stroke: currentcolor;
                    fill: currentcolor;
                }
            </style>

            <g id="midi-logo">
                <path class="icon-stroke" d="M11,21 C16.5228478,21 21,16.5228478 21,11 C21,6.19593378 17.6123878,2.18308725 13.0956435,1.21994044 C12.5255117,1.68950188 11.973918,2.29999994 11,2.3 C10.026082,2.30000007 9.60099125,1.6059539 9.04931995,1.19015455 C4.4602892,2.09754304 1,6.14467455 1,11 C1,16.5228478 5.47715223,21 11,21 Z"></path>
                <g class="icon-fill">
                    <circle cx="11" cy="17" r="1.5"></circle>
                    <circle cx="17" cy="11" r="1.5"></circle>
                    <circle cx="5" cy="11" r="1.5"></circle>
                    <circle cx="6.8" cy="15.2" r="1.5"></circle>
                    <circle cx="15.2" cy="15.2" r="1.5"></circle>
                </g>
            </g>
        </defs>
    </svg>

    <template is="sparky" fn="import:json/tone-synth.json soundstage">
        <div class="bar-block block">
            <h1 class="logo-thumb thumb"><pre>label: {[label]}</pre></h1>

            <template include="components/sparky/transport/template.html#transport"></template>
            <a fn="midi-status" href="#">MIDI</a>

            <button fn="controls-button" title="Show control bindings">Show control bindings</button>
        </div>

        <div class="inputs-block block" fn="get:'nodes[type=input]'">
            <pre>{[id]}</pre>
        </div>

        <div class="outputs-block block" fn="get:'nodes[type=output]'">
            <pre>{[id]}</pre>
        </div>

        <div class="nodes-block block">
            <h2 class="label-block block">Nodes</h2>
            <div class="{[id|append:-node-block]} node-block block" fn="get:nodes each">
                <pre>{[id]} <small>{[type]}</small></pre>
                <template include="node-{[type]}"></template>
            </div>

            <template fn="get:connections">
                <div class="connections-block block">
                    <h2>Connections</h2>
                    <pre fn="each">{[.]}</pre>
                </div>
            </template>

            <div>
                <label class="select-button button">
                    <select>
                        <option value="flanger">Flanger</option>
                        <option value="sampler">Sampler</option>
                        <option value="output">Output</option>
                        <option value="mix">Mix</option>
                        <option value="looper">Looper</option>
                        <option value="saturator">Saturator</option>
                        <option value="tone-synth">Tone Synth</option>
                    </select>
                </label>
            </div>
        </div>


        <!--template fn="get:controls">
                <div class="controls-block block">
                    <h2>Controls</h2>
                    <div fn="each">
                        <pre>{[.]}</pre>
                        <div fn="get:source">
                            <template include="source-device-{[device]}"></template>
                        </div>
                        <div fn="get:data">
                            {[.]} {[latencyCompensation]}
                            <label>Min</label>
                            <input type="number" min="" max="" sparky-value={[min]} />
                            <label>Max</label>
                            <input type="number" min="" max="" sparky-value={[max]} />
                            <label>Transform</label>
                            <select sparky-value="{[transform]}">
                                <option value="linear">Linear</option>
                                <option value="logarithmic">Logarithmic</option>
                                <option value="linear-logarithmic">Linear 0-min Logarithmic min-max</option>
                                <option value="cubic">Cubic</option>
                                <option value="toggle">Toggle</option>
                                <option value="switch">Switch</option>
                                <option value="continuous">Continuous</option>
                            </select>
                            <label>Latency compensation</label>
                            <input type="checkbox" sparky-value={[latencyCompensation]} />
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <div class="events-block block" fn="get:events">
            <h2>Events</h2>
            <pre>
            <table>
                <thead>
                    <tr fn="each">
                        <th>Beat</th>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Data</th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr fn="each">
                        <td>{[0]}</td>
                        <td>{[1]}</td>
                        <td>{[2]}</td>
                        <td>{[3]}</td>
                        <td>{[4]}</td>
                        <td>{[5]}</td>
                        <td>{[6]}</td>
                    </tr>
                </tbody>
            </table>
            </pre>
        </div>

        <div class="sequences-block block" fn="get:sequences">
            <h2>Sequences</h2>
            <div fn="each">
                {[.]}
            </div>
        </div-->
    </template>

    <!-- Tests -->
    <script type="module">
    import { closest, get, query, trigger } from '../../dom/module.js';
    import '../../dom/js/dom.popable.js';
    import '../../dom/js/dom.toggleable.js';

    import './components/sparky/midi/fns.js';
    import "./components/sparky/envelope-control/fns.js";

    import { choose, get as getProp, id, isDefined, Observable, Target, nothing, noop } from '../fn/module.js';

    import * as Fn from '../fn/module.js';
    window.Fn = Fn;

    import * as normalisers from '../fn/modules/normalisers.js';
    window.normalisers = normalisers;

    import * as denormalisers from '../fn/modules/denormalisers.js';
    window.denormalisers = denormalisers;

    import { Stream } from '../fn/module.js';
    window.Stream = Stream;

    import * as dom from '../../dom/module.js';
    window.dom = dom;

    import * as MIDI from '../midi/module.js';
    window.MIDI = MIDI;

    import Soundstage, { transforms } from './module.js';
    window.Soundstage = Soundstage;

    import Sparky, { functions, transforms as pipes, transformers as pipes2, notify, observe, mountConfig, getScope } from '../sparky/module.js';
    window.Sparky = Sparky;
    window.Sparky.getScope = getScope;

    import context from './modules/context.js';
    import KeyboardSource, { learn as learnKeyboard } from './modules/control-sources/keyboard-input-source.js';
    import { learn as learnMIDI } from './modules/control-sources/midi-input-source.js';
    import './components/sparky/param/param.js';

    const assign = Object.assign;


    // Sparky extensions
    //
    // Add custom elements to Sparky mount config and extend functions with
    // soundstage functions

    Object.assign(mountConfig, {
        'range-control':  { attributes: [], booleans: ['disabled'], value: 'number' },
        'rotary-control': { attributes: [], booleans: ['disabled'], value: 'number' }
    });


    const actions = choose({
        'learn-keyboard': function(stage, scope) {
            scope.transform = 'switch';

            // Do a little dance to pass the stop() method down the chain.
            // Todo: find a better way instead of bastardising promises.
            const promise = learnKeyboard();
            const output = promise.then((source) => {
                return stage.createControl(source, scope.target, scope);
            });
            output.stop = promise.stop;
            return output;
        },

        'learn-midi': function(stage, scope) {
            // Do a little dance to pass the stop() method down the chain.
            // Todo: find a better way instead of bastardising promises.
            const promise = learnMIDI(scope.source);
            const output = promise.then((selector) => {
                selector.device = 'midi';
                return stage.Control(selector, scope.target, scope);
            });

            output.stop = promise.stop;
            return output;
        },

        'learn-midi-defaults': function(stage, scope) {
            // Graph node
            const node = scope.target;

            // Defaults, filtered to MIDI events
            const defaults = node.data.constructor.defaultControls
                && node.data.constructor.defaultControls.filter((control) => control.source.device === 'midi');

            // Do a little dance to pass the stop() method down the chain.
            // Todo: find a better way instead of bastardising promises.
            const promise = learnMIDI(scope.source);
            const output = promise.then((selector) => {
                selector.device = 'midi';

                return defaults.map(function(settings) {
                    const source = assign({}, settings.source, selector);

                    // Do not create controls for control routes that already exist
                    if (stage.controls.find((control) => {
                        return control.target === node
                        && control.name === settings.name
                        && control.source.device === source.device
                        && control.source.type === source.type
                        && MIDI.toControlNumber(control.source.name) === MIDI.toControlNumber(source.name)
                    })) {
                        return;
                    }

                    return stage.Control(source, scope.target, settings);
                });
            });

            output.stop = promise.stop;
            return output;
        },

        'piano-keyboard': function(stage, scope) {
            const source = new KeyboardSource('piano');
            return Object.assign(Promise.resolve(
                stage.createControl(source, scope.target, scope)
            ), {
                stop: noop
            });
        }
    });

    functions.soundstage = function(node, scope, params, options) {
        const output = Stream.of();
        var  stage;

        scope.each(function(data) {
            stage = window.stage = new Soundstage(data, { notify: notify, baseURL: '/soundstage' });

            stage.ready(function(stage) {
                output.push(stage);
            });
        });

        // Make it so we can only learn one thing at a time
        var learning = nothing;

        // Delegate events from buttons with an action attribute
        document.body.addEventListener('click', function(e) {
            const node = closest('[action]', e.target);
            if (!node) { return; }
            const action = node.getAttribute('action');
            if (!stage || !action || actions[action]) { return; }
            const scope = getScope(node);
            scope.action = action;
            learning.stop();
            learning = actions(action, stage, Target(scope));
            learning.then(() => {
                scope.action = undefined;
                node.blur();
            })
            .catch(function(e) {
                scope.action = undefined;
                console.log('Learn stopped', e);
            });
        });

        return output;
    };

    functions['transforms'] = function(node, input, params) {
        console.log('TRANS', Object.entries(transforms));

        return Stream.of(Object.entries(transforms));
    };

    const statuses = [
        'note',
        'noteoff',
        'noteon',
    	'polytouch',
    	'control',
    	'program',
    	'channeltouch',
    	'pitch'
    ];

    functions['midi-types'] = function(node, input, params) {
        var types = statuses;
        return Stream.of(types);
    };

    function listen(scope, control) {
        control.tap(function() { scope.latestControl = arguments; });
        return scope;
    }

    functions['controls'] = function(node, input, params) {
        const paramName  = params && params[0];

        return input
        .chain((graphNode) =>
            Observable('.', stage.controls)
            .map(function(controls) {
                // Prepare control scope
                const scope = {
                    source: paramName ? {} : {
                        type: 'all'
                    },

                    target: graphNode,

                    controls: paramName ?
                        controls
                        .filter((control) => control.target === graphNode)
                        .filter((control) =>
                            control.type === 'param'
                            && control.name === paramName) :
                        controls
                        .filter((control) => control.target === graphNode)
                        .filter((control) =>
                            control.type !== 'param'
                            || (control.name === undefined || control.name === 'all')
                        ),

                    type: paramName ? 'param' : undefined ,
                    name: paramName ? paramName : undefined
                };

                // Expose latest incoming control as 'latestControl'
                scope.controls.reduce(listen, scope);
                return scope
            })
        );
    };

    function isMIDIControl(control) {
        return control.source.device === 'midi';
    }

    function isKeyboardControl(control) {
        return control.source.device === 'keyboard';
    }

    functions['filter-controls-midi'] = function(node, input) {
        return input.map((controls) => controls.filter(isMIDIControl));
    };

    functions['filter-controls-keyboard'] = function(node, input) {
        return input.map((controls) => controls.filter(isKeyboardControl));
    };

    // Open all control toggle blocks with bindings, close all
    // control toggle blocks.
    functions['controls-button'] = function(node) {
        node.addEventListener('click', function() {
            const open = query('.controls-toggle-block.active', document);

            // Close 'em
            if (open.length) {
                open.forEach(trigger('dom-deactivate'));
                return;
            }

            // Open 'em'
            const groups = stage.controls.reduce((groups, control) => {
                var group = groups.get(control.target);

                if (!group) {
                    group = [];
                    groups.set(control.target, group);
                }

                group.push(control);
                return groups;
            }, new Map())
            .forEach((group, node) => {
                const names = group.reduce((names, control) => {
                    if (control.type === 'param' && !names.includes(control.name)) {
                        names.push(control.name);
                    }
                    return names;
                }, []);

                names
                .map((name) => get('node-' + node.id + '-' + name + '-toggle'))
                .filter(isDefined)
                .forEach(trigger('dom-activate'));
            })
        });
    };


    pipes['to-control-source-name-template-id'] = function(type) {
        return ({
            note:         'control-source-note-input',
            noteon:       'control-source-note-input',
            noteoff:      'control-source-note-input',
            polytouch:    'control-source-note-input',
            control:      'control-source-control-input',
            program:      'control-source-number-input'
        })[type];
    };

    pipes2['to-note-number'] = {
        tx: function(value) {
            return typeof value === 'number' ?
                value :
                MIDI.toNoteNumber(value) ;
        },

        ix: id
    };

    pipes2['to-control-number'] = {
        tx: function(value) {
            return typeof value === 'number' ?
                value :
                MIDI.toControlNumber(value) ;
        },

        ix: id
    };

    window.pipes = pipes;


    const noteNames = Array.from({ length: 128 }).map((n, i) => ({
        number: i,
        name:   MIDI.toNoteName(i)
    }));

    functions['midi-note-names'] = function() {
        return Stream.of(noteNames);
    };


    const controlNames = Array.from({ length: 128 }).map((n, i) => ({
        number: i,
        name:   MIDI.toControlName(i)
    }));

    functions['midi-control-names'] = function() {
        return Stream.of(controlNames);
    };

    </script>

    <script type="module" src="../dom/components/control/range-control.js"></script>
</body>
